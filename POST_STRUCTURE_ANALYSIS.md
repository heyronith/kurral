# Post Structure & Interaction Analysis

## üîç Complete Analysis Based on Actual Codebase

This document provides a comprehensive breakdown of how posts (Chirps) are structured, how replies work, how rechirps work, and what the "Tune" button does - all based on actual codebase analysis.

---

## 1. POST STRUCTURE (Chirp Type)

### Core Fields (`src/webapp/types/index.ts`)

```typescript
export type Chirp = {
  id: string;                    // Unique post ID (auto-generated by Firestore)
  authorId: string;              // User ID of the post author
  text: string;                  // Plain text content of the post
  topic: Topic;                  // Legacy topic hashtag (e.g., 'dev', 'startups')
  semanticTopics?: string[];     // AI-extracted semantic topics (e.g., ['react', 'tutorials'])
  entities?: string[];           // AI-extracted entities (people, places, products)
  intent?: string;               // AI-detected intent ('question', 'announcement', 'tutorial', etc.)
  analyzedAt?: Date;             // Timestamp when AI analysis was performed
  reachMode: ReachMode;          // 'forAll' or 'tuned'
  tunedAudience?: TunedAudience; // { allowFollowers: boolean, allowNonFollowers: boolean }
  createdAt: Date;               // Post creation timestamp
  rechirpOfId?: string;          // If this is a rechirp, references original chirp ID
  commentCount: number;          // Number of comments on this post
  imageUrl?: string;             // Optional image attachment URL
  scheduledAt?: Date;            // Optional scheduled post time (future date)
  formattedText?: string;        // Optional HTML formatted text (for bold/italic)
};
```

### Key Observations:
- **Two topic systems**: Legacy `topic` (hashtag) + new `semanticTopics` (AI-extracted keywords)
- **Reach modes**: Posts can be `'forAll'` (public) or `'tuned'` (targeted audience)
- **Rechirp tracking**: `rechirpOfId` links back to original post
- **Rich content**: Supports images, formatted text (bold/italic), and scheduling

---

## 2. REPLIES (Comments System)

### Comment Structure (`src/webapp/types/index.ts`)

```typescript
export type Comment = {
  id: string;        // Unique comment ID
  chirpId: string;   // ID of the post this comment belongs to
  authorId: string;  // User ID of comment author
  text: string;      // Comment text (plain text only)
  createdAt: Date;   // Comment creation timestamp
};
```

### How Replies Work:

**Storage** (`src/webapp/lib/firestore.ts:607-663`):
- Comments stored in separate `comments` Firestore collection
- Each comment has `chirpId` to link to parent post
- `commentCount` on Chirp is updated atomically using `increment(1)` when comment is created

**Real-time Updates** (`src/webapp/lib/firestore.ts:786-803`):
- `subscribeToComments(chirpId, callback)` sets up real-time listener
- Listens to comments collection filtered by `chirpId`, ordered by `createdAt` ascending
- Updates UI automatically when new comments are added

**UI Component** (`src/webapp/components/CommentSection.tsx`):
- Expandable/collapsible comment section
- Shows comment count: "Reply (5)" if comments exist
- Comment form appears when expanded
- Lists all comments with author name, handle, and timestamp
- Comments sorted chronologically (oldest first)

**Engagement Tracking**:
- When user clicks "Reply" button: `tuningService.trackChirpEngagement(chirp.id)`
- When comment is posted: `tuningService.trackChirpEngagement(chirp.id)`
- Stored in localStorage as array of chirp IDs (`chirp_engaged_ids`)

---

## 3. RECHIRP System

### How Rechirp Works (`src/webapp/components/ChirpCard.tsx:65-79`)

When user clicks "Rechirp" button:

```typescript
const handleRechirp = async () => {
  if (!currentUser) return;
  
  try {
    await addChirp({
      authorId: currentUser.id,        // Rechirp author is the current user
      text: chirp.text,                // Copies original text
      topic: chirp.topic,              // Copies legacy topic
      reachMode: 'forAll',             // ‚ö†Ô∏è ALWAYS 'forAll' (not tuned)
      rechirpOfId: chirp.id,           // Links to original chirp
      // ‚ö†Ô∏è Does NOT copy semanticTopics, entities, or intent
      // ‚ö†Ô∏è Does NOT copy imageUrl or formattedText
    });
  } catch (error) {
    console.error('Error rechirping:', error);
  }
};
```

### Rechirp Display (`src/webapp/components/ChirpCard.tsx:110-115`):

If a post is a rechirp (`chirp.rechirpOfId` exists):
- Shows badge at top: "‚Üª Rechirped by {author.name}"
- Displays with original content
- Shows rechirper as the author (not original author)

### Firestore Handling (`src/webapp/lib/firestore.ts:324-327`):

```typescript
// Only include rechirpOfId if it exists
if (chirp.rechirpOfId) {
  chirpData.rechirpOfId = chirp.rechirpOfId;
}
```

### Key Observations:
- **No semantic data copied**: Rechirps don't inherit `semanticTopics`, `entities`, or `intent` from original
- **Always public**: Rechirps are always `'forAll'` mode (no tuned audience)
- **Creates new post**: Rechirp creates a completely new Chirp document in Firestore
- **Original preserved**: Original post unchanged; rechirp is a separate post that references it

---

## 4. "TUNE" BUTTON - Feed Algorithm Tuning

### What "Tune" Does (`src/webapp/components/TuneMenu.tsx`)

The "Tune" button appears next to "Rechirp" in every ChirpCard. Clicking it opens a dropdown menu with 3 options:

#### Option 1: "More from this person"
**Action**: Increases following weight in For You feed algorithm
- Cycles through: `'none' ‚Üí 'light' ‚Üí 'medium' ‚Üí 'heavy'`
- Updates `forYouConfig.followingWeight` in ConfigStore
- Makes posts from this author appear more frequently in For You feed

#### Option 2: "More about #{topic}"
**Action**: Adds this post's topic to liked topics
- Adds topic to `forYouConfig.likedTopics` array
- Posts about this topic get +25 score boost in For You algorithm
- Topic is displayed in feed as a liked topic preference

#### Option 3: "Less like this"
**Action**: Mutes this post's topic
- Adds topic to `forYouConfig.mutedTopics` array
- Posts with this topic are filtered out from For You feed
- Prevents similar content from appearing

### How It Works:
- **Affects feed algorithm**: Changes `ForYouConfig` in Zustand store (`useConfigStore`)
- **Not about the specific post**: Doesn't hide/delete the current post
- **Personalization**: Tunes the For You feed for the current user only
- **Persistent**: Changes are saved to ConfigStore (likely persisted in localStorage)

### Tracking (`src/webapp/components/ChirpCard.tsx:89-94`):

When viewing a post:
```typescript
useEffect(() => {
  if (currentUser && !isCurrentUser) {
    tuningService.trackChirpView(chirp.id);  // Tracks that user viewed this post
  }
}, [chirp.id, currentUser, isCurrentUser]);
```

- Stores viewed chirp IDs in localStorage (`chirp_viewed_ids`)
- Used by TuningAgent to analyze user behavior patterns
- Helps AI suggest feed improvements

---

## 5. POST CREATION FLOW

### Normal Post (`src/webapp/components/Composer.tsx:510-625`):

1. **User types content** in contentEditable div (supports bold/italic formatting)
2. **AI Analysis** (if post length >= 4 characters):
   - `reachAgent.analyzePostContent()` extracts:
     - `semanticTopics` (e.g., ['react', 'tutorial'])
     - `entities` (people, places mentioned)
     - `intent` ('question', 'announcement', etc.)
     - `suggestedLegacyTopic` (fallback hashtag)
   - Shows `AnalyzingModal` during analysis
3. **Resolve Topic**: Uses selected topic ‚Üí AI suggestion ‚Üí user's topics ‚Üí 'dev' fallback
4. **Create Chirp**: Saves to Firestore with all metadata
5. **Update Topic Engagement**: Increments topic engagement counter
6. **Real-time**: New post appears in feeds via listeners

### Rechirp Post:

1. **User clicks "Rechirp"** on existing post
2. **Create new Chirp**: Copies `text` and `topic` only
3. **Set `rechirpOfId`**: Links to original post ID
4. **Always 'forAll' mode**: No tuned audience
5. **No AI analysis**: Rechirps don't get semantic analysis

---

## 6. DATA FLOW DIAGRAM

```
User Creates Post
    ‚Üì
Composer.tsx (handlePost)
    ‚Üì
AI Analysis (ReachAgent.analyzePostContent)
    ‚Üì Extract: semanticTopics, entities, intent, suggestedLegacyTopic
    ‚Üì
chirpService.createChirp()
    ‚Üì
Firestore 'chirps' collection
    ‚Üì
Real-time listeners update feeds
    ‚Üì
ChirpCard displays post

---

User Clicks "Reply"
    ‚Üì
CommentSection.tsx (handleSubmit)
    ‚Üì
commentService.createComment()
    ‚Üì
Firestore 'comments' collection + increment commentCount
    ‚Üì
Real-time listener (subscribeToComments) updates UI

---

User Clicks "Rechirp"
    ‚Üì
ChirpCard.tsx (handleRechirp)
    ‚Üì
addChirp({ text, topic, rechirpOfId: originalId, reachMode: 'forAll' })
    ‚Üì
New Chirp document in Firestore
    ‚Üì
Displays as "Rechirped by {user}" with original content

---

User Clicks "Tune"
    ‚Üì
TuneMenu.tsx dropdown opens
    ‚Üì
User selects option:
    - "More from this person" ‚Üí Increase followingWeight
    - "More about #{topic}" ‚Üí Add to likedTopics
    - "Less like this" ‚Üí Add to mutedTopics
    ‚Üì
ConfigStore updated
    ‚Üì
For You feed algorithm recalculates scores
```

---

## 7. KEY INSIGHTS

### Replies:
- ‚úÖ Separate Comment type stored in `comments` collection
- ‚úÖ Real-time updates via Firestore listeners
- ‚úÖ Comment count updated atomically on Chirp document
- ‚úÖ Engagement tracked for feed tuning

### Rechirps:
- ‚ö†Ô∏è **Limitation**: Does NOT copy semantic topics/entities from original
- ‚ö†Ô∏è **Always public**: Rechirps are always 'forAll' mode (can't be tuned)
- ‚ö†Ô∏è **No content copying**: Doesn't copy images or formatted text
- ‚úÖ Creates new post with reference to original via `rechirpOfId`

### Tune Button:
- ‚úÖ **Feed personalization**: Tunes For You algorithm, not the specific post
- ‚úÖ **Three actions**: Boost author, boost topic, mute topic
- ‚úÖ **Persistent**: Changes saved in ConfigStore
- ‚úÖ **Tracking**: Views and engagement tracked for AI suggestions

---

## 8. POTENTIAL IMPROVEMENTS

1. **Rechirps should copy semantic data**: Currently rechirps lose semantic topics/entities, making them harder to find via semantic search
2. **Rechirps could preserve format**: Images and formatted text are lost on rechirp
3. **Tune menu could be clearer**: Users might think it affects the current post, not their feed
4. **Comment threading**: Currently flat structure; could support reply-to-reply

